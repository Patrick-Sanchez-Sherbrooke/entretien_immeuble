-- EXPORT COMPLET EN UN SEUL SCRIPT SQL
WITH 
-- Tables et colonnes
table_ddl AS (
    SELECT 
        table_name,
        'CREATE TABLE ' || table_name || ' (' || E'\n  ' ||
        string_agg(
            column_name || ' ' || 
            CASE 
                WHEN data_type = 'character varying' THEN 'VARCHAR(' || character_maximum_length || ')'
                WHEN data_type = 'character' THEN 'CHAR(' || character_maximum_length || ')'
                WHEN data_type = 'numeric' THEN 'NUMERIC(' || numeric_precision || ',' || numeric_scale || ')'
                ELSE UPPER(data_type)
            END ||
            CASE WHEN is_nullable = 'NO' THEN ' NOT NULL' ELSE '' END ||
            CASE WHEN column_default IS NOT NULL THEN ' DEFAULT ' || column_default ELSE '' END,
            E',\n  '
            ORDER BY ordinal_position
        ) || E'\n);' as ddl,
        1 as sort_order
    FROM 
        information_schema.columns
    WHERE 
        table_schema = 'public'
    GROUP BY 
        table_name
),
-- Index
index_ddl AS (
    SELECT 
        tablename,
        indexdef || ';' as ddl,
        2 as sort_order
    FROM 
        pg_indexes
    WHERE 
        schemaname = 'public'
        AND indexname NOT LIKE '%_pkey'
),
-- Contraintes
constraint_ddl AS (
    SELECT 
        tc.table_name,
        'ALTER TABLE ' || tc.table_name || 
        ' ADD CONSTRAINT ' || tc.constraint_name || ' ' ||
        CASE tc.constraint_type
            WHEN 'PRIMARY KEY' THEN 'PRIMARY KEY (' || string_agg(kcu.column_name, ', ') || ')'
            WHEN 'FOREIGN KEY' THEN 'FOREIGN KEY (' || string_agg(kcu.column_name, ', ') || 
                ') REFERENCES ' || ccu.table_name || '(' || string_agg(ccu.column_name, ', ') || ')'
            WHEN 'UNIQUE' THEN 'UNIQUE (' || string_agg(kcu.column_name, ', ') || ')'
        END || ';' as ddl,
        3 as sort_order
    FROM 
        information_schema.table_constraints AS tc
        LEFT JOIN information_schema.key_column_usage AS kcu
            ON tc.constraint_name = kcu.constraint_name
        LEFT JOIN information_schema.constraint_column_usage AS ccu
            ON ccu.constraint_name = tc.constraint_name
    WHERE 
        tc.table_schema = 'public'
        AND tc.constraint_type IN ('PRIMARY KEY', 'FOREIGN KEY', 'UNIQUE')
    GROUP BY 
        tc.table_name, tc.constraint_name, tc.constraint_type, ccu.table_name
),
-- Fonctions
function_ddl AS (
    SELECT 
        p.proname as table_name,
        pg_get_functiondef(p.oid) || ';' as ddl,
        4 as sort_order
    FROM 
        pg_proc p
        JOIN pg_namespace n ON p.pronamespace = n.oid
    WHERE 
        n.nspname = 'public'
)
-- Combiner tout
SELECT ddl 
FROM (
    SELECT table_name, ddl, sort_order FROM table_ddl
    UNION ALL
    SELECT tablename, ddl, sort_order FROM index_ddl
    UNION ALL
    SELECT table_name, ddl, sort_order FROM constraint_ddl
    UNION ALL
    SELECT table_name, ddl, sort_order FROM function_ddl
) combined
ORDER BY sort_order, table_name;
